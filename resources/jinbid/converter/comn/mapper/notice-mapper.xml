<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="jinbid.converter.comn.mapper.NoticeDao">
	
	<select id="selectExistedNotice" parameterType="Map" resultType="jinbid.converter.comn.vo.Notice">
			 SELECT	 *  
				FROM SY_NOTI.NOTI
        	 WHERE PRF_ID = #{prfId}
        ORDER BY  id desc
        		LIMIT 1 
	</select>
	
    <!--        공고를 입력한다.	    -->
    <insert id="insertNotice" parameterType="jinbid.converter.comn.vo.Notice" keyProperty="id"   useGeneratedKeys="true">
   	  <selectKey keyProperty="id" resultType="Long" order="BEFORE">
		    select id  FROM SY_NOTI.NOTI WHERE PRF_ID =  #{prfId}
                        union select 0 as id from dual limit 1;
	  </selectKey>
		<if test="id==0">			
        INSERT INTO SY_NOTI.NOTI
				(
				NOTI_NO,
				NOTI_SEQ,
				NOTI_NM,
				CNST_NO,
				NOTI_KIND_CD,
				COLCT_METH_CD,
				NOTI_PROG_STAT_CD,
				NOTI_DSTNCT_CD,
				RPSNT_ORGNZ_CD,
				ORDER_OFFI_CD,
				ACTUL_DNTT_CD,
				NOTI_STRT_DT,
				BDDPR_STRT_DT,
				REGST_FIN_DT,
				BDDPR_FIN_DT,
				BDDPR_PRTC_CMP_CNT,
				OPBD_DT,
				OPBD_PRARG_PRICE,
				OPBD_STAT_CD,
				ORDER_OFFI_OPBD_DT,
				SITE_DESC_DT,
				SITE_DESC_PLAC,
				PRESM_AMT,
				BASE_AMT,
				CNTR_MTHD_ID,
				SORT_ORDR,
				NEWEST_NOTI_YN,
				DWNLMT_RT,
				MIN_AS_RT,
				MAX_AS_RT,
				PRDC_BASE_AMT,
				CFMT_UNDWRT_ST_ID,
				REBID_NO,
				ARSTUDWRT_APPLY_FIN_DT,
				CHRGR_NM,
				CHRGR_DEPT_NM,
				CHRGR_TELNO,
				CHRGR_EMAIL,
				CNST_AREA_LOCAT,
				CNST_PERD,
				CORCT_RSN,
				RMRK,
				TALK_MEMO,
				SITE_DESC_MANDA_YN,
				SCHTWR_YN,
				PATENT_NTCNQ_YN,
				GURAMT_PYM_YN,
				FEMALE_HNDC_CO_YN,
				SPCFCT_BID_YN,
				MNPR_BID_YN,
				ACRSLT_IGNOR_YN,
				VLTRN_NOTI_YN,
				UNIVAL_NOTI_YN,
				PRVSTL_NOTI_YN,
				PRVT_NOTI_YN,
				EMG_NOTI_YN,
				RENOTI_YN,
				PSTPONE_NOTI_YN,
				ELECT_BID_YN,
				SPDMAGMT_FIN_DT,
				MNRCR_OUTSRC_RATE,
				UNION_TRSF_PSBL_YN,
				SHR_TRSF_PSBL_YN,
				AREA_DUTY_YN,
				SINGL_PSBL_YN,
				FIRST_INPUT_DT,
				FIRST_INPTPS,
				LAST_UPDT_DT,
				LAST_AMNDR,
				USE_YN,
				PRF_ID,
				PRF_DT)
        VALUES (
        		#{notiNo},
                #{notiSeq},
                #{notiNm},
                #{cnstNo},
                #{notiKindCd},
                #{colctMethCd},
                #{notiProgStatCd},
                #{notiDstnctCd},
                #{rpsntOrgnzCd},
					#{orderOffiCdNm},
					#{actulDnttCdNm},
                #{notiStrtDt},
                #{bddprStrtDt},
                #{regstFinDt},
                #{bddprFinDt},
                #{bddprPrtcCmpCnt},
                #{opbdDt},
                #{opbdPrargPrice},
                #{opbdStatCd},
                #{orderOffiOpbdDt},
                FROM_UNIXTIME(#{siteDescDt}),
                #{siteDescPlac},
                #{presmAmt},
                #{baseAmt},
                #{cntrMthdId},
                #{sortOrdr},
                #{newestNotiYn},
                #{dwnlmtRt},
                #{minAsRt},
                #{maxAsRt},
                #{prdcBaseAmt},
                #{cfmtUndwrtStId},
                #{rebidNo},
                #{arstudwrtApplyFinDt},
                #{chrgrNm},
                #{chrgrDeptNm},
                #{chrgrTelno},
                #{chrgrEmail},
                #{cnstAreaLocat},
                #{cnstPerd},
                #{corctRsn},
                #{rmrk},
                #{talkMemo},
                #{siteDescMandaYn},
                #{schtwrYn},
                #{patentNtcnqYn},
                #{guramtPymYn},
                #{femaleHndcCoYn},
                #{spcfctBidYn},
                #{mnprBidYn},
                #{acrsltIgnorYn},
                #{vltrnNotiYn},
                #{univalNotiYn},
                #{prvstlNotiYn},
                #{prvtNotiYn},
                #{emgNotiYn},
                #{renotiYn},
                #{pstponeNotiYn},
                #{electBidYn},
                #{spdmagmtFinDt},
                #{mnrcrOutsrcRate},
                #{unionTrsfPsblYn},
                #{shrTrsfPsblYn},
                #{areaDutyYn},
                #{singlPsblYn},
                now(),
                'batch2_insert',
                now(),
                'batch2_insert',
                'Y',
                #{prfId},
                #{prfDt}
                )
         </if>
         <if test="id!=0">
            UPDATE SY_NOTI.NOTI
            SET
  			    OPBD_PRARG_PRICE 		 = #{opbdPrargPrice},		/* 투찰참여업체수 */
	            BDDPR_PRTC_CMP_CNT = #{bddprPrtcCmpCnt},	/* 개찰예정가격 */
	            OPBD_STAT_CD 				 = #{opbdStatCd},				/* 개찰상태코드 */
	            ORDER_OFFI_OPBD_DT 	 = #{orderOffiOpbdDt}, 		/* 발주처 개찰일시 */
	           DWNLMT_RT 					 = #{dwnlmtRt},					/*	하한율 */
	           MIN_AS_RT 						 = #{minAsRt},						/* 최소 사정율 */
	           MAX_AS_RT 						 = #{maxAsRt},						/* 최고 사정율 */
	           LAST_UPDT_DT 					 = now(),
	           LAST_AMNDR					 = 'batch2_update'
	        WHERE ID=#{id}
         </if>
    </insert>
    
	<!--  발주처 코드 업데이트-->
	<update id="updateOrderOffiCd" >
		    UPDATE 	SY_NOTI.NOTI a left join DMND_ORGNZ b
    		FORCE 		INDEX FOR JOIN (ALL_NAME)
    		ON				a.ORDER_OFFI_CD = b.ALL_ORGNZ_NM
    		SET 			ORDER_OFFI_CD = coalesce(b.ORGNZ_CD,'SY000000'),
    							a.LAST_AMNDR='batch2_update'
    		WHERE		a.LAST_AMNDR='batch2_insert'
	</update>

	<!--  실수요기관코드 업데이트-->
	<update id="updateActulDnttCd" >
		    UPDATE 	SY_NOTI.NOTI a left join DMND_ORGNZ b
    		FORCE 		INDEX FOR JOIN (ALL_NAME)
    		ON				a.ACTUL_DNTT_CD = b.ALL_ORGNZ_NM
    		SET 			ACTUL_DNTT_CD = coalesce(b.ORGNZ_CD,'SY000000'),
    							a.LAST_AMNDR='batch2_completed'
    		WHERE		a.LAST_AMNDR='batch2_update'
	</update>
	
	<!-- 적격심사기준ID 업데이트  -->
	<!-- 나머지 1) 	SELECT ID FROM SY_NOTI.CFMT_UNDWRT_ST 
								WHERE RPSNT_ORGNZ_CD = {대표기관(SY_NOTI.NOTI.RPSNT_ORGNZ_CD)}
						 2)	CFMT_UNDWRT_ST에 없는것 지자체3년 "1" (조정예정)	 -->
	<update id="updateCfmtUndwrtStId">
		UPDATE			SY_NOTI.NOTI a 
		LEFT JOIN 		CFMT_UNDWRT_ST b
		ON					a.RPSNT_ORGNZ_CD = b.RPSNT_ORGNZ_CD
		SET		 			CFMT_UNDWRT_ST_ID = coalesce(b.id,1)
		WHERE	 		a.CFMT_UNDWRT_ST_ID is null;
	</update>	
	
	
	
    <!--        공고를 수정한다.    -->
    <update id="updateNotice" parameterType="jinbid.converter.comn.vo.Notice" keyProperty="id"   useGeneratedKeys="true">
    	  <selectKey keyProperty="id" resultType="String" order="BEFORE">
		    select id FROM SY_NOTI.NOTI WHERE PRF_ID = #{prfId}
		  </selectKey>
    	UPDATE SY_NOTI.NOTI
    			SET 
						OPBD_PRARG_PRICE 		 = #{opbdPrargPrice},		/* 투찰참여업체수 */
						BDDPR_PRTC_CMP_CNT = #{bddprPrtcCmpCnt},	/* 개찰예정가격 */
						OPBD_STAT_CD 				 = #{opbdStatCd},				/* 개찰상태코드 */
						ORDER_OFFI_OPBD_DT 	 = #{orderOffiOpbdDt}, 		/* 발주처 개찰일시 */
						DWNLMT_RT 					 = #{dwnlmtRt},					/*	하한율 */
						MIN_AS_RT 						 = #{minAsRt},						/* 최소 사정율 */
						MAX_AS_RT 						 = #{maxAsRt},						/* 최고 사정율 */
						LAST_UPDT_DT 				 = now(),
						LAST_AMNDR					 = 'batch_update'
 	   WHERE   PRF_ID=#{id}

    </update>
	

</mapper>